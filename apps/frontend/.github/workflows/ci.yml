name: CI
permissions:
    contents: read

on:
    pull_request:
        branches: [main]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup-node-pnpm
            - name: Lint
              run: pnpm lint

    test:
        needs: lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup-node-pnpm
            - name: Run tests
              run: pnpm test

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup-node-pnpm
            - name: Build
              run: pnpm build

    e2e:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/setup-node-pnpm
            - name: Get Vercel Preview URL
              id: vercel_url
              run: |
                  # Wait for Vercel deployment and extract preview URL
                  DEPLOYMENT_URL=$(gh deployment list --repo ${{ github.repository }} --environment preview --json url --jq '.[0].url' 2>/dev/null || echo "")
                  if [ -z "$DEPLOYMENT_URL" ]; then
                    echo "Waiting for Vercel deployment..."
                    for i in {1..30}; do
                      DEPLOYMENT_URL=$(gh deployment list --repo ${{ github.repository }} --environment preview --json url --jq '.[0].url' 2>/dev/null || echo "")
                      if [ ! -z "$DEPLOYMENT_URL" ]; then
                        break
                      fi
                      sleep 2
                    done
                  fi
                  echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Install Playwright Browsers
              run: pnpm exec playwright install --with-deps
            - name: Run E2E Tests
              run: pnpm exec playwright test
              env:
                  BASE_URL: ${{ steps.vercel_url.outputs.deployment_url }}
                  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
                  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
